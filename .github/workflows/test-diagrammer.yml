name: Test Diagrammer on Self

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  DIAGRAMMER_VERSION: 'v1.0.4'

jobs:
  generate-diagrams:
    name: Generate Architecture Diagrams
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: Cache generated diagrams
      uses: actions/cache@v4
      with:
        path: docs/architecture
        key: ${{ runner.os }}-diagrams-${{ hashFiles('src/**/*.js', 'src/**/*.ts', 'tests/**/*.js', 'tests/**/*.ts') }}
        restore-keys: |
          ${{ runner.os }}-diagrams-
        
    - name: Mock diagram generation (for local testing)
      if: ${{ env.ACT == 'true' }}
      run: |
        echo "ğŸ”§ Mock diagram generation for local testing"
        mkdir -p docs/architecture
        echo "# Mock Architecture Diagram" > docs/architecture/mock-diagram.md
        echo "This is a mock diagram for local testing with act"
        echo "ğŸ“Š Generated mock diagram in docs/architecture/"
        
    - name: Install dependencies
      if: ${{ env.ACT != 'true' }}
      run: |
        echo "ğŸ“¦ Installing dependencies for enhanced diagram generation..."
        npm ci --no-audit --no-fund
        
    - name: Generate Architecture Diagrams (GitHub Actions)
      if: ${{ env.ACT != 'true' }}
      run: |
        echo "ğŸ”§ Running enhanced local diagram generation..."
        node src/index.js
      env:
        INPUT_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        INPUT_OUTPUT_PATH: 'docs/architecture'
        INPUT_LANGUAGES: 'javascript,typescript,python'
        INPUT_CONFIG_FILE: '.diagrammer.yml'
      continue-on-error: false
        
    - name: Verify diagram generation
      run: |
        echo "ğŸ” Verifying enhanced diagram generation..."
        if [ -d "docs/architecture" ]; then
          echo "âœ… Architecture directory found"
          echo "ğŸ“Š Generated files:"
          find docs/architecture -name "*.md" -type f | head -10
          echo ""
          echo "ğŸ“ˆ File count: $(find docs/architecture -name "*.md" -type f | wc -l) markdown files"
          echo ""
          echo "ğŸ¨ Enhanced diagram types:"
          echo "  - Architecture Diagram: $(test -f docs/architecture/architecture.md && echo "âœ…" || echo "âŒ")"
          echo "  - Layered Architecture: $(test -f docs/architecture/layeredArchitecture.md && echo "âœ…" || echo "âŒ")"
          echo "  - API Flow: $(test -f docs/architecture/apiFlow.md && echo "âœ…" || echo "âŒ")"
          echo "  - Data Flow: $(test -f docs/architecture/dataFlow.md && echo "âœ…" || echo "âŒ")"
          echo "  - Event Flow: $(test -f docs/architecture/eventFlow.md && echo "âœ…" || echo "âŒ")"
          echo "  - Service Communication: $(test -f docs/architecture/serviceCommunication.md && echo "âœ…" || echo "âŒ")"
        else
          echo "âŒ Architecture directory not found"
          exit 1
        fi
        
    - name: Commit and push generated diagrams
      if: github.event_name != 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        git add docs/architecture
        if ! git diff --cached --quiet; then
          git commit -m "docs(architecture): update generated diagrams [skip ci]"
          git push origin HEAD:${{ github.ref_name }}
        else
          echo "No changes to commit."
        fi