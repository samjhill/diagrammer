name: Test Diagrammer on Self

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  DIAGRAMMER_VERSION: 'v1.3.0'

jobs:
  generate-diagrams:
    name: Generate Architecture Diagrams
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: Cache generated diagrams
      uses: actions/cache@v4
      with:
        path: docs/architecture
        key: ${{ runner.os }}-diagrams-${{ hashFiles('src/**/*.js', 'src/**/*.ts', 'tests/**/*.js', 'tests/**/*.ts') }}
        restore-keys: |
          ${{ runner.os }}-diagrams-
        
    - name: Mock diagram generation (for local testing)
      if: ${{ env.ACT == 'true' }}
      run: |
        echo "🔧 Mock diagram generation for local testing"
        mkdir -p docs/architecture
        echo "# Mock Architecture Diagram" > docs/architecture/mock-diagram.md
        echo "This is a mock diagram for local testing with act"
        echo "📊 Generated mock diagram in docs/architecture/"
        
    - name: Install dependencies
      if: ${{ env.ACT != 'true' }}
      run: |
        echo "📦 Installing dependencies for enhanced diagram generation..."
        npm ci --no-audit --no-fund
        
    - name: Generate Architecture Diagrams (GitHub Actions)
      if: ${{ env.ACT != 'true' }}
      uses: samjhill/diagrammer@latest
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        output_path: 'docs/architecture'
        languages: 'javascript,typescript,python'
        auto_commit: 'false'
      continue-on-error: false
        
    - name: Verify diagram generation
      run: |
        echo "🔍 Verifying enhanced diagram generation..."
        if [ -d "docs/architecture" ]; then
          echo "✅ Architecture directory found"
          echo "📊 Generated files:"
          find docs/architecture -name "*.md" -type f | head -10
          echo ""
          echo "📈 File count: $(find docs/architecture -name "*.md" -type f | wc -l) markdown files"
          echo ""
          echo "🎨 Enhanced diagram types:"
          echo "  - Architecture Diagram: $(test -f docs/architecture/architecture.md && echo "✅" || echo "❌")"
          echo "  - Layered Architecture: $(test -f docs/architecture/layeredArchitecture.md && echo "✅" || echo "❌")"
          echo "  - API Flow: $(test -f docs/architecture/apiFlow.md && echo "✅" || echo "❌")"
          echo "  - Data Flow: $(test -f docs/architecture/dataFlow.md && echo "✅" || echo "❌")"
          echo "  - Event Flow: $(test -f docs/architecture/eventFlow.md && echo "✅" || echo "❌")"
          echo "  - Service Communication: $(test -f docs/architecture/serviceCommunication.md && echo "✅" || echo "❌")"
        else
          echo "❌ Architecture directory not found"
          exit 1
        fi
        
    - name: Commit and push generated diagrams
      if: github.event_name != 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        echo "🔧 Configuring Git for commit..."
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"
        git config --global --add safe.directory /github/workspace
        
        echo "📝 Checking for changes..."
        git add docs/architecture/
        
        if ! git diff --cached --quiet; then
          echo "✅ Changes detected, committing..."
          git commit -m "docs(architecture): update generated diagrams with enhanced metrics and insights [skip ci]"
          
          echo "🚀 Pushing changes..."
          git push origin HEAD:${{ github.ref_name }}
          echo "✅ Successfully pushed diagram updates"
        else
          echo "ℹ️ No changes to commit."
        fi